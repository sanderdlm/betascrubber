{% extends 'base.twig' %}

{% block content %}
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 50vh; padding: 2rem; text-align: center;">
        <div style="margin-bottom: 2rem;">
            <div class="loader" style="width: 60px; height: 60px; border: 3px solid #e0e0e0; border-top: 3px solid #000; animation: spin 1s linear infinite;"></div>
        </div>

        <h1 style="margin-bottom: 0.5rem;">Processing</h1>
        <p style="color: #999; margin-bottom: 2rem;">This usually takes 30-60 seconds</p>

        <div style="width: 100%; max-width: 300px; height: 3px; background: #e0e0e0; overflow: hidden;">
            <div id="progress-bar" style="height: 100%; background: #000; width: 0%; transition: width 0.5s;"></div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script>
        const videoHash = '{{ video_hash }}';
        const progressBar = document.getElementById('progress-bar');
        let progress = 0;
        let checkCount = 0;

        // Simulate progress
        const progressInterval = setInterval(() => {
            if (progress < 90) {
                progress += Math.random() * 10;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
            }
        }, 1000);

        // Check for completion
        const checkInterval = setInterval(async () => {
            checkCount++;

            try {
                const response = await fetch('/check-status/' + videoHash);
                const data = await response.json();

                if (data.status === 'completed') {
                    clearInterval(progressInterval);
                    clearInterval(checkInterval);
                    progressBar.style.width = '100%';
                    setTimeout(() => {
                        window.location.href = '/view-frames/' + videoHash;
                    }, 500);
                } else if (data.status === 'error') {
                    clearInterval(progressInterval);
                    clearInterval(checkInterval);
                    alert('Processing failed. Please try again.');
                    window.location.href = '/';
                }
            } catch (e) {
                // Continue checking
            }

            // Timeout after 5 minutes
            if (checkCount > 60) {
                clearInterval(progressInterval);
                clearInterval(checkInterval);
                alert('Processing is taking longer than expected. Please check back later.');
                window.location.href = '/';
            }
        }, 5000);
    </script>
{% endblock %}
